<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GMP Inventory Simulator ‚Äî V1.3</title>

<style>
:root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{margin:0;background:#0b1220;color:#e8eefc}
header{padding:16px 20px;background:#0f1a33;border-bottom:1px solid #22335f}
h1{margin:0;font-size:18px}
.sub{font-size:12px;opacity:.7}
.wrap{max-width:1300px;margin:auto;padding:16px}

.tabs{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.tabbtn{padding:10px 14px;border-radius:12px;border:1px solid #2a3c70;background:#0f1a33;color:#e8eefc;font-weight:600;cursor:pointer}
.tabbtn.active{background:#1a2d5a;border-color:#3f5fb0}

.card{background:#0f1a33;border:1px solid #22335f;border-radius:18px;padding:14px}
.hide{display:none}

.table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #22335f;padding:8px;font-size:12px;vertical-align:top}
th{text-align:left}
.right{text-align:right}

.pill{padding:4px 8px;border-radius:999px;font-size:11px;font-weight:800}
.ok{background:#1c3;color:#061}
.low{background:#ffb020;color:#3b2200}
.exp{background:#ff7a18;color:#3b2200}
.bad{background:#ff4d6d;color:#36000a}

a.link{color:#9bb6ff;cursor:pointer;text-decoration:underline}

.filters{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.filter{padding:6px 10px;border-radius:999px;border:1px solid #2a3c70;background:#0b1220;cursor:pointer;font-size:12px}
.filter.active{background:#1a2d5a}

input,select,button,textarea{
border-radius:10px;border:1px solid #2a3c70;
background:#0b1220;color:#e8eefc;padding:8px 10px
}
button.primary{background:#2b64ff;border-color:#2b64ff;font-weight:800}
button.danger{background:#c7363a;border-color:#c7363a}
button.ghost{background:transparent}

.kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px;font-size:12px}
.sectionTitle{margin-top:14px;font-weight:900;font-size:13px}
.doc{display:flex;gap:8px;align-items:center;font-size:12px;flex-wrap:wrap}
.doc a{color:#9bb6ff}
.hint{font-size:12px;opacity:.8;line-height:1.35}
.topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
hr{border:0;border-top:1px solid #22335f;margin:14px 0}

/* Modals */
.modalBg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10;padding:16px}
.modal{background:#0f1a33;border-radius:18px;border:1px solid #22335f;padding:14px;width:min(980px,96vw);max-height:88vh;overflow:auto}
.modalHeader{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap}
.modalTitle{font-weight:950}

/* Print only report modal (clean A4) */
@media print {
  body{background:#fff;color:#000}
  header,.tabs,#warehouse,#kit,#log,#reports{display:none!important}
  #cardBg{display:none!important}
  #reportBg{display:flex!important;position:static!important;background:transparent!important;padding:0!important}
  #reportModal{border:none!important;box-shadow:none!important;background:#fff!important;color:#000!important;max-height:none!important;overflow:visible!important}
  .noPrint{display:none!important}
  table th, table td{border-bottom:1px solid #ccc!important;color:#000!important}
  .pill{border:1px solid #888!important}
}
</style>
</head>

<body>
<header>
  <h1>GMP Inventory Simulator ‚Äî V1.3</h1>
  <div class="sub">Warehouse ‚Ä¢ Kit ‚Ä¢ Audit Log ‚Ä¢ Inventory Card ‚Ä¢ Documents ‚Ä¢ Reports ‚Ä¢ Storage & Location</div>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tabbtn active" data-tab="warehouse">Warehouse</button>
    <button class="tabbtn" data-tab="kit">Kit</button>
    <button class="tabbtn" data-tab="log">Audit Log</button>
    <button class="tabbtn" data-tab="reports">Reports</button>
  </div>

  <!-- Warehouse -->
  <section id="warehouse" class="card">
    <div class="filters">
      <button class="filter active" data-filter="ALL">All</button>
      <button class="filter" data-filter="PROBLEM">Problems</button>
      <button class="filter" data-filter="LOW">Low stock</button>
      <button class="filter" data-filter="EXP">Expiring</button>
      <button class="filter" data-filter="BAD">Expired</button>

      <span class="hint" style="margin-left:6px">Sort:</span>
      <select id="whSort">
        <option value="product">Product</option>
        <option value="expiry">Expiry</option>
        <option value="available">Available</option>
        <option value="location">Location</option>
        <option value="storage">Storage</option>
      </select>
    </div>

    <div class="hint">Click Product/IRN to open Inventory Card (with documents and logs).</div>

    <table class="table">
      <thead>
        <tr>
          <th>IRN</th>
          <th>Product</th>
          <th>Lot</th>
          <th>Expiry</th>
          <th>Storage</th>
          <th>Location</th>
          <th class="right">On Hand</th>
          <th class="right">Picked</th>
          <th class="right">Available</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="whBody"></tbody>
    </table>
  </section>

  <!-- Kit -->
  <section id="kit" class="card hide">
    <div class="topbar">
      <input id="kitName" value="KIT-001"/>
      <select id="kitAction">
        <option value="PICK">Pick</option>
        <option value="RETURN">Return</option>
      </select>
      <select id="kitItem"></select>
      <input id="kitQty" type="number" min="1" value="1" style="width:110px"/>
      <input id="kitUser" value="Operator" style="min-width:140px"/>
      <button class="primary" id="kitSubmit">Submit</button>
    </div>

    <div class="hint">
      Safeguards: Pick cannot exceed Available. Return cannot exceed net picked for this kit.
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Date &amp; Time</th><th>Kit</th><th>Action</th><th>IRN</th><th>Lot</th><th class="right">Qty</th><th>User</th>
        </tr>
      </thead>
      <tbody id="kitTxBody"></tbody>
    </table>
  </section>

  <!-- Audit Log -->
  <section id="log" class="card hide">
    <div class="topbar">
      <input id="logSearch" placeholder="Search log‚Ä¶" style="min-width:260px"/>
      <button class="ghost" id="exportJson">Export JSON</button>
      <button class="danger" id="clearLog">Clear log</button>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Date &amp; Time</th><th>Product</th><th>IRN</th><th>Lot</th>
          <th class="right">Qty</th><th>User</th><th>Comment (Kit)</th>
        </tr>
      </thead>
      <tbody id="logBody"></tbody>
    </table>
  </section>

  <!-- Reports -->
  <section id="reports" class="card hide">
    <div class="hint">Reports are print-ready. Use ‚ÄúPrint / Save as PDF‚Äù.</div>

    <hr>

    <div class="sectionTitle">1) Audit Log Report</div>
    <div class="topbar">
      <select id="auditPreset">
        <option value="today">Today</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="custom">Custom</option>
      </select>
      <input id="auditFrom" type="date"/>
      <input id="auditTo" type="date"/>
      <button class="primary" id="runAuditReport">Generate</button>
      <button class="ghost" id="printAuditReport">Print / Save as PDF</button>
    </div>

    <div id="auditReportPreview"></div>

    <hr>

    <div class="sectionTitle">2) Kit Record</div>
    <div class="topbar">
      <select id="kitSelect"></select>
      <button class="primary" id="runKitReport">Generate</button>
      <button class="ghost" id="printKitReport">Print / Save as PDF</button>
    </div>

    <div id="kitReportPreview"></div>

    <hr>

    <div class="sectionTitle">3) Weekly Stock Check</div>
    <div class="topbar">
      <select id="stockMode">
        <option value="problems">Problems first</option>
        <option value="expiring">Expiring ‚â§90 days (incl. expired)</option>
        <option value="low">Low stock</option>
        <option value="negative">Negative stock</option>
        <option value="all">All</option>
      </select>
      <button class="primary" id="runStockReport">Generate</button>
      <button class="ghost" id="printStockReport">Print / Save as PDF</button>
    </div>

    <div id="stockReportPreview"></div>
  </section>
</div>

<!-- Inventory Card Modal -->
<div class="modalBg" id="cardBg">
  <div class="modal" id="cardModal">
    <div class="modalHeader">
      <div>
        <div class="modalTitle" id="cardTitle"></div>
        <div class="sub" id="cardSubtitle"></div>
      </div>
      <div class="topbar noPrint">
        <button class="ghost" id="printCardBtn">Print / Save as PDF</button>
        <button class="danger" id="closeCardBtn">Close</button>
      </div>
    </div>

    <div class="kv" id="cardKV"></div>

    <div class="sectionTitle">Documents</div>
    <div id="docs"></div>

    <div class="topbar noPrint">
      <select id="docType"><option>COA</option><option>SDS</option><option>Other</option></select>
      <input type="file" id="docFile"/>
      <button class="primary" id="uploadDoc">Upload</button>
    </div>

    <div class="sectionTitle">Picked history</div>
    <table class="table">
      <thead><tr><th>Date &amp; Time</th><th>Kit</th><th>Action</th><th class="right">Qty</th><th>User</th></tr></thead>
      <tbody id="pickedBody"></tbody>
    </table>

    <div class="sectionTitle">Audit log (this IRN + Lot)</div>
    <table class="table">
      <thead><tr><th>Date &amp; Time</th><th>Product</th><th>IRN</th><th>Lot</th><th class="right">Qty</th><th>User</th><th>Comment</th></tr></thead>
      <tbody id="cardAuditBody"></tbody>
    </table>
  </div>
</div>

<!-- Report Print Modal -->
<div class="modalBg" id="reportBg">
  <div class="modal" id="reportModal">
    <div class="modalHeader noPrint">
      <div>
        <div class="modalTitle" id="reportTitle">Report</div>
        <div class="sub" id="reportSubtitle"></div>
      </div>
      <div class="topbar">
        <button class="ghost" id="reportPrintBtn">Print / Save as PDF</button>
        <button class="danger" id="reportCloseBtn">Close</button>
      </div>
    </div>
    <div id="reportContent"></div>
  </div>
</div>

<script>
/* ===== Storage key ===== */
const LS_KEY = "gmp_v13_full";

/* ===== Seed data (add your real data here) ===== */
const seed = [
  {
    id:"1",
    product:"Opti-MEM",
    irn:"1254/25",
    lot:"3021876",
    expiry:"2026-05-01",
    storage:"2‚Äì8¬∞C",
    location:"WH-ROOM1 / Shelf A",
    onHand:3,
    min:2,
    docs:[]
  },
  {
    id:"2",
    product:"CryoStor 100 mL",
    irn:"1376/26",
    lot:"25093",
    expiry:"2027-05-01",
    storage:"-80¬∞C",
    location:"WH-DFR-02 / Upper shelf",
    onHand:1,
    min:2,
    docs:[]
  }
];

/* ===== State =====
  wh: [{...}]
  kit: [{ts, kit, action, id, irn, lot, qty, user}]
  log: [{ts, product, irn, lot, qty, user, comment}]
*/
let S = (() => {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return { wh: seed, kit: [], log: [] };
    const parsed = JSON.parse(raw);
    if (!parsed || !Array.isArray(parsed.wh)) return { wh: seed, kit: [], log: [] };
    return parsed;
  } catch {
    return { wh: seed, kit: [], log: [] };
  }
})();

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(S)); }
save();

/* ===== Helpers ===== */
const pad2 = n => String(n).padStart(2,"0");
function toISODateLocal(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

function fmtTS(iso){
  const d = new Date(iso);
  return d.toLocaleString(undefined, {year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"});
}

function daysToExpiry(isoDate){
  const d = new Date(isoDate);
  return Math.floor((d - new Date())/86400000);
}

function pickedNet(itemId){
  let p = 0;
  for(const t of S.kit){
    if(t.id !== itemId) continue;
    p += (t.action === "PICK" ? 1 : -1) * Number(t.qty||0);
  }
  return p;
}

function statusOf(it){
  const av = it.onHand - pickedNet(it.id);
  const du = daysToExpiry(it.expiry);

  if(av < 0) return ["NEGATIVE","bad"];
  if(du < 0) return ["EXPIRED","bad"];
  if(du <= 90) return ["EXPIRING","exp"];
  if(av <= it.min) return ["LOW","low"];
  return ["OK","ok"];
}

function uniqueKits(){
  const set = new Set();
  for(const t of S.kit) set.add(t.kit);
  return [...set].sort();
}

/* ===== Render: Warehouse ===== */
function renderWarehouse(){
  const f = document.querySelector(".filter.active")?.dataset?.filter || "ALL";
  const sort = document.getElementById("whSort")?.value || "product";

  let items = S.wh.map(it=>{
    const p = pickedNet(it.id);
    const av = it.onHand - p;
    const [st, cls] = statusOf(it);
    return {...it, picked:p, available:av, st, cls};
  });

  items = items.filter(it=>{
    if(f==="PROBLEM" && it.st==="OK") return false;
    if(f==="LOW" && it.st!=="LOW") return false;
    if(f==="EXP" && it.st!=="EXPIRING") return false;
    if(f==="BAD" && it.st!=="EXPIRED") return false;
    return true;
  });

  const s = (x)=> (x||"").toString().toLowerCase();
  items.sort((a,b)=>{
    if(sort==="product") return s(a.product).localeCompare(s(b.product));
    if(sort==="expiry") return new Date(a.expiry) - new Date(b.expiry);
    if(sort==="available") return a.available - b.available;
    if(sort==="location") return s(a.location).localeCompare(s(b.location));
    if(sort==="storage") return s(a.storage).localeCompare(s(b.storage));
    return 0;
  });

  whBody.innerHTML = "";
  for(const it of items){
    whBody.insertAdjacentHTML("beforeend", `
      <tr>
        <td><a class="link" data-open-card="${it.id}">${it.irn}</a></td>
        <td><a class="link" data-open-card="${it.id}">${it.product}</a></td>
        <td>${it.lot}</td>
        <td>${it.expiry}</td>
        <td>${it.storage || ""}</td>
        <td>${it.location || ""}</td>
        <td class="right">${it.onHand}</td>
        <td class="right">${it.picked}</td>
        <td class="right">${it.available}</td>
        <td><span class="pill ${it.cls}">${it.st}</span></td>
      </tr>
    `);
  }

  // bind clicks
  whBody.querySelectorAll("[data-open-card]").forEach(a=>{
    a.addEventListener("click", ()=>{
      openCard(a.getAttribute("data-open-card"));
    });
  });

  // fill kit dropdown with location visible
  kitItem.innerHTML = "";
  for(const it of S.wh){
    kitItem.insertAdjacentHTML("beforeend",
      `<option value="${it.id}">${it.irn} ‚Äî ${it.product} ‚Äî ${it.location || ""} ‚Äî Lot ${it.lot}</option>`
    );
  }
}

/* ===== Render: Kit Tx ===== */
function renderKitTx(){
  const sorted = [...S.kit].sort((a,b)=> new Date(b.ts) - new Date(a.ts));
  kitTxBody.innerHTML = sorted.map(t=>`
    <tr>
      <td>${fmtTS(t.ts)}</td>
      <td>${t.kit}</td>
      <td>${t.action}</td>
      <td>${t.irn}</td>
      <td>${t.lot}</td>
      <td class="right">${t.qty}</td>
      <td>${t.user}</td>
    </tr>
  `).join("");
}

/* ===== Render: Audit Log ===== */
function renderLog(){
  const q = (logSearch.value||"").toLowerCase().trim();
  const rows = [...S.log]
    .sort((a,b)=> new Date(b.ts) - new Date(a.ts))
    .filter(e=>{
      if(!q) return true;
      const blob = `${e.ts} ${e.product} ${e.irn} ${e.lot} ${e.qty} ${e.user} ${e.comment}`.toLowerCase();
      return blob.includes(q);
    });

  logBody.innerHTML = rows.map(e=>`
    <tr>
      <td>${fmtTS(e.ts)}</td>
      <td>${e.product}</td>
      <td>${e.irn}</td>
      <td>${e.lot}</td>
      <td class="right">${e.qty}</td>
      <td>${e.user}</td>
      <td>${e.comment || ""}</td>
    </tr>
  `).join("");
}

/* ===== Inventory Card ===== */
let currentItem = null;

function openCard(id){
  currentItem = S.wh.find(x=>x.id===id);
  if(!currentItem) return;

  const p = pickedNet(id);
  const av = currentItem.onHand - p;
  const [st, cls] = statusOf(currentItem);

  cardTitle.textContent = `Inventory Card ‚Äî ${currentItem.product}`;
  cardSubtitle.textContent = `IRN ${currentItem.irn} ‚Ä¢ Lot ${currentItem.lot} ‚Ä¢ Status ${st}`;

  cardKV.innerHTML = `
    <div>Product</div><div>${currentItem.product}</div>
    <div>IRN</div><div>${currentItem.irn}</div>
    <div>Lot</div><div>${currentItem.lot}</div>
    <div>Expiry</div><div>${currentItem.expiry}</div>
    <div>Storage</div><div>${currentItem.storage || ""}</div>
    <div>Location</div><div>${currentItem.location || ""}</div>
    <div>Min Qty</div><div>${currentItem.min}</div>
    <div>On Hand</div><div>${currentItem.onHand}</div>
    <div>Picked (net)</div><div>${p}</div>
    <div>Available</div><div>${av}</div>
  `;

  const docsArr = currentItem.docs || [];
  docs.innerHTML = docsArr.length
    ? docsArr.map(d=>`
        <div class="doc">
          üìÑ <b>${d.type}</b>:
          <a href="${d.data}" target="_blank">${d.name}</a>
          <span class="sub">(${fmtTS(d.uploadedAt)} by ${d.uploadedBy})</span>
        </div>
      `).join("")
    : `<div class="hint">No documents uploaded.</div>`;

  const txForItem = [...S.kit].filter(t=>t.id===id).sort((a,b)=> new Date(b.ts) - new Date(a.ts));
  pickedBody.innerHTML = txForItem.map(t=>`
    <tr>
      <td>${fmtTS(t.ts)}</td>
      <td>${t.kit}</td>
      <td>${t.action}</td>
      <td class="right">${t.qty}</td>
      <td>${t.user}</td>
    </tr>
  `).join("");

  const aud = [...S.log].filter(e=> e.irn===currentItem.irn && e.lot===currentItem.lot).sort((a,b)=> new Date(b.ts) - new Date(a.ts));
  cardAuditBody.innerHTML = aud.map(e=>`
    <tr>
      <td>${fmtTS(e.ts)}</td>
      <td>${e.product}</td>
      <td>${e.irn}</td>
      <td>${e.lot}</td>
      <td class="right">${e.qty}</td>
      <td>${e.user}</td>
      <td>${e.comment || ""}</td>
    </tr>
  `).join("");

  cardBg.style.display = "flex";
}

function closeCard(){
  cardBg.style.display = "none";
  currentItem = null;
}

/* ===== Documents upload ===== */
uploadDoc.addEventListener("click", ()=>{
  const f = docFile.files[0];
  if(!f || !currentItem) return;

  const r = new FileReader();
  r.onload = ()=>{
    currentItem.docs = currentItem.docs || [];
    currentItem.docs.push({
      name: f.name,
      type: docType.value,
      data: r.result,
      uploadedBy: (kitUser.value || "User"),
      uploadedAt: new Date().toISOString()
    });
    save();
    openCard(currentItem.id);
    docFile.value = "";
  };
  r.readAsDataURL(f);
});

/* ===== Kit action with safeguards ===== */
kitSubmit.addEventListener("click", ()=>{
  const it = S.wh.find(x=>x.id===kitItem.value);
  if(!it) return;

  const qty = Math.max(1, Number(kitQty.value || 1));
  const action = kitAction.value;
  const kit = kitName.value.trim() || "KIT";
  const user = kitUser.value.trim() || "Operator";

  const av = it.onHand - pickedNet(it.id);

  if(action === "PICK" && qty > av){
    alert("Cannot pick more than Available.");
    return;
  }

  if(action === "RETURN"){
    const pickedForThisKit = S.kit
      .filter(t=> t.kit === kit && t.id === it.id)
      .reduce((acc,t)=> acc + (t.action==="PICK"?1:-1)*Number(t.qty||0), 0);

    if(qty > pickedForThisKit){
      alert("Cannot return more than net picked for this kit.");
      return;
    }
  }

  const ts = new Date().toISOString();

  S.kit.push({
    ts, kit, action,
    id: it.id,
    irn: it.irn,
    lot: it.lot,
    qty,
    user
  });

  S.log.push({
    ts,
    product: it.product,
    irn: it.irn,
    lot: it.lot,
    qty: (action==="PICK") ? -qty : +qty,
    user,
    comment: `${action} ‚Äî Kit: ${kit}`
  });

  save();
  rerenderAll();
});

/* ===== Reports ===== */
function auditRangeFromPreset(){
  const preset = auditPreset.value;
  const now = new Date();
  const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999);
  let start;

  if(preset==="today"){
    start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
    return {from:start, to:end, label:"Today"};
  }
  if(preset==="7" || preset==="30"){
    const back = Number(preset);
    start = new Date(end.getTime() - (back-1)*86400000);
    start.setHours(0,0,0,0);
    return {from:start, to:end, label:`Last ${back} days`};
  }

  // custom
  const f = auditFrom.value ? new Date(auditFrom.value+"T00:00:00") : new Date(end.getTime()-6*86400000);
  const t = auditTo.value ? new Date(auditTo.value+"T23:59:59.999") : end;
  return {from:f, to:t, label:`Custom: ${auditFrom.value||"(auto)"} ‚Üí ${auditTo.value||"(today)"}`};
}

function generateAuditReportHTML(range){
  const rows = [...S.log].filter(e=>{
    const ts = new Date(e.ts);
    return ts >= range.from && ts <= range.to;
  }).sort((a,b)=> new Date(a.ts) - new Date(b.ts));

  return `
    <div class="kv" style="margin-top:10px">
      <div><b>Generated</b></div><div>${new Date().toLocaleString()}</div>
      <div><b>Range</b></div><div>${range.from.toLocaleString()} ‚Äî ${range.to.toLocaleString()}</div>
      <div><b>Records</b></div><div>${rows.length}</div>
    </div>

    <table class="table" style="margin-top:12px">
      <thead>
        <tr>
          <th>Date &amp; Time</th><th>Product</th><th>IRN</th><th>Lot</th>
          <th class="right">Qty</th><th>User</th><th>Comment</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(e=>`
          <tr>
            <td>${fmtTS(e.ts)}</td>
            <td>${e.product}</td>
            <td>${e.irn}</td>
            <td>${e.lot}</td>
            <td class="right">${e.qty}</td>
            <td>${e.user}</td>
            <td>${e.comment || ""}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <div style="margin-top:14px" class="kv">
      <div><b>Prepared by</b></div><div>__________________</div>
      <div><b>Checked by</b></div><div>__________________</div>
      <div><b>Date</b></div><div>__________________</div>
      <div><b>Signature</b></div><div>__________________</div>
    </div>
  `;
}

function generateKitRecordHTML(kitNameValue){
  const tx = [...S.kit].filter(t=>t.kit===kitNameValue).sort((a,b)=> new Date(a.ts) - new Date(b.ts));

  const summary = {};
  for(const t of tx){
    const key = `${t.irn}||${t.lot}`;
    summary[key] = summary[key] || {irn:t.irn, lot:t.lot, net:0};
    summary[key].net += (t.action==="PICK"?1:-1)*t.qty;
  }
  const sumArr = Object.values(summary);

  return `
    <div class="kv" style="margin-top:10px">
      <div><b>Kit</b></div><div>${kitNameValue}</div>
      <div><b>Generated</b></div><div>${new Date().toLocaleString()}</div>
      <div><b>Transactions</b></div><div>${tx.length}</div>
    </div>

    <div class="sectionTitle" style="margin-top:12px">Kit Summary (net)</div>
    <table class="table">
      <thead><tr><th>IRN</th><th>Lot</th><th class="right">Net</th></tr></thead>
      <tbody>
        ${sumArr.map(s=>`<tr><td>${s.irn}</td><td>${s.lot}</td><td class="right">${s.net}</td></tr>`).join("")}
      </tbody>
    </table>

    <div class="sectionTitle" style="margin-top:12px">Kit Transactions</div>
    <table class="table">
      <thead><tr><th>Date &amp; Time</th><th>User</th><th>Action</th><th>IRN</th><th>Lot</th><th class="right">Qty</th></tr></thead>
      <tbody>
        ${tx.map(t=>`
          <tr>
            <td>${fmtTS(t.ts)}</td>
            <td>${t.user}</td>
            <td>${t.action}</td>
            <td>${t.irn}</td>
            <td>${t.lot}</td>
            <td class="right">${t.qty}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <div style="margin-top:14px" class="kv">
      <div><b>Prepared by</b></div><div>__________________</div>
      <div><b>Checked by</b></div><div>__________________</div>
      <div><b>Date</b></div><div>__________________</div>
      <div><b>Signature</b></div><div>__________________</div>
    </div>
  `;
}

function generateStockCheckHTML(mode){
  const rows = S.wh.map(it=>{
    const p = pickedNet(it.id);
    const av = it.onHand - p;
    const du = daysToExpiry(it.expiry);
    const [st, cls] = statusOf(it);
    return {...it, picked:p, available:av, daysToExpiry:du, st, cls};
  });

  let filtered = rows;
  if(mode==="expiring") filtered = rows.filter(r => r.st==="EXPIRING" || r.st==="EXPIRED");
  if(mode==="low") filtered = rows.filter(r => r.st==="LOW");
  if(mode==="negative") filtered = rows.filter(r => r.st==="NEGATIVE");
  if(mode==="problems") filtered = rows.filter(r => r.st!=="OK");

  // sort
  const pr = (s)=> ({NEGATIVE:1,EXPIRED:2,EXPIRING:3,LOW:4,OK:5}[s]||9);
  filtered.sort((a,b)=>{
    if(mode==="problems") return pr(a.st)-pr(b.st) || a.daysToExpiry-b.daysToExpiry;
    if(mode==="expiring") return a.daysToExpiry-b.daysToExpiry;
    if(mode==="low") return a.available-b.available;
    if(mode==="negative") return a.available-b.available;
    return pr(a.st)-pr(b.st);
  });

  return `
    <div class="kv" style="margin-top:10px">
      <div><b>Generated</b></div><div>${new Date().toLocaleString()}</div>
      <div><b>Mode</b></div><div>${mode}</div>
      <div><b>Items</b></div><div>${filtered.length}</div>
    </div>

    <table class="table" style="margin-top:12px">
      <thead>
        <tr>
          <th>IRN</th><th>Product</th><th>Lot</th><th>Expiry</th>
          <th>Storage</th><th>Location</th>
          <th class="right">Min</th>
          <th class="right">On Hand</th>
          <th class="right">Picked</th>
          <th class="right">Available</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(r=>`
          <tr>
            <td>${r.irn}</td>
            <td>${r.product}</td>
            <td>${r.lot}</td>
            <td>${r.expiry}</td>
            <td>${r.storage || ""}</td>
            <td>${r.location || ""}</td>
            <td class="right">${r.min}</td>
            <td class="right">${r.onHand}</td>
            <td class="right">${r.picked}</td>
            <td class="right">${r.available}</td>
            <td><span class="pill ${r.cls}">${r.st}</span></td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <div style="margin-top:14px" class="kv">
      <div><b>Prepared by</b></div><div>__________________</div>
      <div><b>Checked by</b></div><div>__________________</div>
      <div><b>Date</b></div><div>__________________</div>
      <div><b>Signature</b></div><div>__________________</div>
    </div>
  `;
}

function openReport(title, subtitle, html){
  reportTitle.textContent = title;
  reportSubtitle.textContent = subtitle || "";
  reportContent.innerHTML = html;
  reportBg.style.display = "flex";
}

function closeReport(){
  reportBg.style.display = "none";
  reportContent.innerHTML = "";
}

function refreshKitSelector(){
  const kits = uniqueKits();
  kitSelect.innerHTML = kits.length
    ? kits.map(k=>`<option value="${k}">${k}</option>`).join("")
    : `<option value="">(no kits yet)</option>`;
}

/* Report buttons */
runAuditReport.addEventListener("click", ()=>{
  const range = auditRangeFromPreset();
  auditReportPreview.innerHTML = generateAuditReportHTML(range);
});
printAuditReport.addEventListener("click", ()=>{
  const range = auditRangeFromPreset();
  openReport("Audit Log Report", range.label, generateAuditReportHTML(range));
});
runKitReport.addEventListener("click", ()=>{
  const k = kitSelect.value;
  kitReportPreview.innerHTML = k ? generateKitRecordHTML(k) : `<div class="hint">No kit selected.</div>`;
});
printKitReport.addEventListener("click", ()=>{
  const k = kitSelect.value;
  if(!k){ alert("Select a kit first."); return; }
  openReport("Kit Record", k, generateKitRecordHTML(k));
});
runStockReport.addEventListener("click", ()=>{
  stockReportPreview.innerHTML = generateStockCheckHTML(stockMode.value);
});
printStockReport.addEventListener("click", ()=>{
  openReport("Weekly Stock Check", stockMode.options[stockMode.selectedIndex].textContent, generateStockCheckHTML(stockMode.value));
});

/* Report preset date enabling */
auditPreset.addEventListener("change", ()=>{
  const isCustom = auditPreset.value === "custom";
  auditFrom.disabled = !isCustom;
  auditTo.disabled = !isCustom;
});

/* ===== Utilities ===== */
exportJson.addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(S,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "gmp_export.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

clearLog.addEventListener("click", ()=>{
  if(!confirm("Clear audit log?")) return;
  S.log = [];
  save();
  rerenderAll();
});

logSearch.addEventListener("input", renderLog);

/* ===== UI bindings ===== */
document.querySelectorAll(".tabbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    ["warehouse","kit","log","reports"].forEach(id=>document.getElementById(id).classList.add("hide"));
    document.getElementById(btn.dataset.tab).classList.remove("hide");

    if(btn.dataset.tab === "reports"){
      refreshKitSelector();
    }
  });
});

document.querySelectorAll(".filter").forEach(f=>{
  f.addEventListener("click", ()=>{
    document.querySelectorAll(".filter").forEach(x=>x.classList.remove("active"));
    f.classList.add("active");
    renderWarehouse();
  });
});

document.getElementById("whSort").addEventListener("change", renderWarehouse);

document.getElementById("closeCardBtn").addEventListener("click", closeCard);
document.getElementById("printCardBtn").addEventListener("click", ()=>window.print());

document.getElementById("reportCloseBtn").addEventListener("click", closeReport);
document.getElementById("reportPrintBtn").addEventListener("click", ()=>window.print());

/* ===== Initial dates ===== */
(function initReportDates(){
  const today = new Date();
  auditFrom.value = toISODateLocal(new Date(today.getTime()-6*86400000));
  auditTo.value = toISODateLocal(today);
  auditPreset.dispatchEvent(new Event("change"));
})();

/* ===== Main rerender ===== */
function rerenderAll(){
  renderWarehouse();
  renderKitTx();
  renderLog();
  refreshKitSelector();

  auditReportPreview.innerHTML = "";
  kitReportPreview.innerHTML = "";
  stockReportPreview.innerHTML = "";
}

/* ===== Init ===== */
rerenderAll();
</script>
</body>
</html>
